<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MECC AMAL v1.4 - Light Blue Popup</title>
    <script src="https://cdn.tailwindcss.com">
    //MECC DASHBOARD 
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f9ff; /* Very light blue background */
            -webkit-tap-highlight-color: transparent;
        }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Modern Popup Notification */
        .popup-notif {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) scale(0.9);
            width: 90%;
            max-width: 380px;
            background-color: #e0f2fe; /* Light Blue 100 */
            border: 1px solid #bae6fd; /* Light Blue 200 */
            border-radius: 24px;
            padding: 20px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .popup-notif.active {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) scale(1);
        }

        .nav-active {
            color: #0369a1; /* sky-700 */
            transform: translateY(-2px);
        }

        .pulse-sky {
            animation: pulse-sky 2s infinite;
        }
        @keyframes pulse-sky {
            0% { box-shadow: 0 0 0 0 rgba(14, 165, 233, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(14, 165, 233, 0); }
            100% { box-shadow: 0 0 0 0 rgba(14, 165, 233, 0); }
        }
    </style>
</head>
<body class="pb-24">

    <!-- Popup Notification -->
    <div id="popupNotif" class="popup-notif flex flex-col items-center text-center gap-2">
        <div id="popupIcon" class="text-4xl mb-1"></div>
        <h3 id="popupTitle" class="font-bold text-sky-900 text-lg"></h3>
        <p id="popupMsg" class="text-sm text-sky-700 font-medium leading-relaxed"></p>
        <button onclick="hidePopup()" class="mt-2 text-[10px] font-bold uppercase tracking-widest text-sky-400 hover:text-sky-600">Tutup</button>
    </div>

    <!-- Header -->
    <nav class="bg-sky-900 text-white p-5 sticky top-0 z-50 shadow-md flex justify-between items-center rounded-b-[30px]">
        <div>
            <h1 class="font-bold text-lg leading-tight">MECC AMAL <span class="text-[10px] bg-sky-700 px-2 py-0.5 rounded-full ml-1">v1.4</span></h1>
            <p class="text-[10px] text-sky-300 uppercase tracking-widest font-bold">Respon Pintar Cloud</p>
        </div>
        <div id="cloudStatus" class="flex items-center gap-2 text-[10px] font-bold bg-white/10 px-3 py-2 rounded-full border border-white/20">
            <div id="statusDot" class="w-2 h-2 rounded-full bg-red-500"></div>
            <span id="statusText">LUAR TALIAN</span>
        </div>
    </nav>

    <div class="max-w-md mx-auto p-4 space-y-5">
        
        <!-- TAB: UTAMA -->
        <div id="dashboard" class="tab-content active space-y-5">
            <!-- Kad Program -->
            <div class="bg-white p-7 rounded-[32px] shadow-sm border border-sky-50 relative overflow-hidden">
                <div class="absolute -top-4 -right-4 w-24 h-24 bg-sky-50 rounded-full opacity-50"></div>
                <h2 class="text-[11px] font-black text-sky-400 uppercase tracking-[0.2em] mb-2">Program Aktif</h2>
                <div id="activeProgDisplay">
                    <p class="text-2xl font-black text-slate-800 leading-tight" id="dispProgName">Sila Pilih Program</p>
                    <div class="mt-3 inline-flex items-center gap-2 bg-sky-50 text-sky-700 text-[10px] font-bold px-3 py-1.5 rounded-full border border-sky-100" id="dispProgId">
                        ID: ---
                    </div>
                </div>
            </div>

            <!-- Statistik -->
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-white p-6 rounded-[32px] shadow-sm border border-sky-50 text-center">
                    <p class="text-3xl font-black text-sky-600" id="countKes">0</p>
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-tighter mt-1">Laporan Saya</p>
                </div>
                <div class="bg-white p-6 rounded-[32px] shadow-sm border border-sky-50 text-center">
                    <p class="text-3xl font-black text-sky-600" id="countRes">0</p>
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-tighter mt-1">Responder Aktif</p>
                </div>
            </div>

            <!-- Log Kehadiran -->
            <div class="space-y-3">
                <div class="flex justify-between items-center px-2">
                    <h3 class="text-[11px] font-black text-slate-500 uppercase tracking-widest">Senarai Bertugas</h3>
                    <button onclick="fetchAttendance()" class="p-2 bg-sky-100 rounded-full text-sky-600 hover:rotate-180 transition-all duration-500">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M23 4v6h-6"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
                    </button>
                </div>
                <div id="attendanceList" class="space-y-3">
                    
                    <p class="text-xs text-slate-400 text-center py-8 italic bg-white/50 rounded-[32px] border border-dashed border-sky-200">Menyemak data Cloud...</p>
                    document.getElementById('attendanceList').innerHTML = 
                        `<p class="text-xs text-slate-400 text-center py-8 italic bg-white/50 rounded-[32px] border border-dashed border-sky-200">
                              Tiada data ditemui.
                        </p>`;

                </div>
            </div>
        </div>

        <!-- TAB: INPUT DISEMBUNYIKAN  //send case to cloud di dashboard mecc dibuang   --     
        <div id="update" class="tab-content space-y-6">
            <section class="bg-white p-6 rounded-[32px] shadow-sm space-y-5 border border-sky-50">
                <h3 class="font-bold text-slate-800 flex items-center gap-2 text-sm border-b border-slate-50 pb-4">
                    <span class="p-2 bg-sky-50 rounded-xl">üë•</span> Kawalan Responder
                </h3>
                
                <div class="space-y-4">
                    <div>
                        <label class="text-[10px] font-black text-slate-400 uppercase ml-2 tracking-widest">Nama Anda</label>
                        <input id="resNameInput" placeholder="Contoh: Ahmad Ali" class="w-full p-4 mt-1 bg-slate-50 border-0 rounded-2xl text-sm font-semibold focus:ring-2 focus:ring-sky-500 outline-none" oninput="saveResponder(this.value)">
                    </div>
                    
                    <div class="flex gap-3">
                        <button onclick="handleDuty('startDuty')" class="flex-1 bg-sky-600 text-white p-4 rounded-2xl font-black text-xs shadow-lg shadow-sky-100 active:scale-95 transition-all">MULA TUGAS</button>
                        <button onclick="handleDuty('endDuty')" class="flex-1 bg-white border-2 border-slate-100 text-slate-500 p-4 rounded-2xl font-black text-xs active:scale-95 transition-all">TAMAT TUGAS</button>
                    </div>
                </div>
                -->
            <section class="bg-white p-6 rounded-[32px] shadow-sm space-y-5 border border-sky-50">
                <div class="pt-2">
                    <label class="text-[10px] font-black text-slate-400 uppercase ml-2 tracking-widest">Pilih Program</label>
                    <select id="progSelect" class="w-full p-4 mt-1 bg-slate-50 border-0 rounded-2xl text-sm font-bold text-sky-800" onchange="selectProgram(this.value)">
                         <option value="">-- Muat Turun Senarai --</option>
                    </select>
                </div>
                </section>
              <!-- </div>-->
       
        
        <!-- TAB: TETAPAN -- Tambah dalam tab Settings ---->
        <div id="settings" class="tab-content space-y-4">
            
                    
             <!-- 1. Backend -->
              <div class="bg-white p-4 rounded-xl border border-sky-100 shadow-sm">
            <div class="flex justify-between items-center">
          <h4 class="font-bold text-sky-600 text-sm">Backend</h4>
          <span id="backendStatus" class="text-xs font-black px-2 py-1 rounded-full border">LUAR TALIAN</span>
        </div>
        <p class="text-[10px] text-slate-400 mt-1">Status sambungan Cloud</p>
                <button onclick="toggleBackendSetup()" class="mt-2 w-full bg-sky-50 text-sky-700 py-2 rounded-xl border border-sky-100 font-bold text-[10px]">Setup URL Script</button>
                  <!-- Form setup URL script -->
        <div id="backendSetupForm" class="hidden mt-2 space-y-2">
          <input type="text" id="backendUrlInput" placeholder="Masukkan URL Script Cloud" class="w-full p-2 border border-sky-100 rounded-xl text-xs">
          <button onclick="updateBackendUrl()" class="w-full bg-sky-600 text-white py-1.5 rounded-xl text-[10px] font-bold">Simpan</button>
           <button id="btnVerify" onclick="verifyCloud()" class="...">SAHKAN</button>
            <button id="btnReset" onclick="resetCloud()" class="hidden ...">RESET</button>


        </div>
      </div>
    <!-- VERIFYCLOUD 
     <button id="btnVerify" onclick="verifyCloud()" class="w-full bg-sky-600 text-white p-4 rounded-2xl font-black text-sm shadow-lg shadow-sky-100">SAHKAN SAMBUNGAN</button>
     -->
                 <section class="bg-white p-7 rounded-[32px] shadow-sm border border-sky-50">
                    <h3 class="font-bold text-slate-800 border-b border-slate-50 pb-4 mb-6 text-sm">
                        üìã Kemaskini Program
                    </h3>
      <!-- 2. Program -->
  <div class="bg-white p-4 rounded-xl border border-sky-100 shadow-sm">
    <div class="flex justify-between items-center">
      <h4 class="font-bold text-sky-600 text-sm">Program</h4>
      <span id="programDots" class="text-xs font-black px-2 py-1 rounded-full border">‚óè‚óè‚óè</span>
    </div>
    <p class="text-[10px] text-slate-400 mt-1">Bilangan program disimpan</p>
    <button onclick="toggleProgramForm()" class="mt-2 w-full bg-sky-50 text-sky-700 py-2 rounded-xl border border-sky-100 font-bold text-[10px]">Kemaskini Program</button>

    <!-- Form kemaskini program //updateProgram()-->
    <div id="programForm" class="hidden mt-2 space-y-2">
<!-- Pilihan Simpan -->
<div class="flex gap-3 mt-2">
  <label class="flex items-center gap-2 text-[10px] font-bold text-slate-500">
    <input type="radio" name="saveMode" value="local" checked>
    Simpan Lokal
  </label>
  <label class="flex items-center gap-2 text-[10px] font-bold text-slate-500">
    <input type="radio" name="saveMode" value="cloud">
    Simpan Cloud
  </label>
</div>

        
      <input type="text" id="progName" placeholder="Nama Program" class="w-full p-2 border border-sky-100 rounded-xl text-xs">
      <input type="date" id="progDate" class="w-full p-2 border border-sky-100 rounded-xl text-xs">
        <input type="time" id="progTime" class="w-full p-2 border rounded-xl text-xs">

      <input type="text" id="progLocation" placeholder="Lokasi Program" class="w-full p-2 border border-sky-100 rounded-xl text-xs">
      <div class="flex justify-between items-center">
        <span id="progIdDisplay" class="text-[10px] font-bold">ID: 260116+001</span>
        <button onclick="saveProgram()" class="bg-sky-600 text-white text-[10px] font-bold py-1.5 px-2 rounded-xl">
            SIMPAN / KEMASKINI PROGRAM</button>
     
      </div>
    </div>
  </div>

</div>
                </section>
        </div>
    </div>
    


    <!-- Navigasi Bawah -->
    <div class="fixed bottom-0 w-full bg-white/80 backdrop-blur-xl border-t border-sky-50 flex justify-around p-5 z-50 rounded-t-[32px] shadow-[0_-10px_25px_-5px_rgba(0,0,0,0.05)]">
        <button onclick="nav('dashboard')" class="nav-btn flex flex-col items-center gap-1.5 text-slate-300 transition-all duration-300" id="nav-dashboard">
            <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M9 3v18"/><path d="M3 9h18"/></svg>
            <span class="text-[9px] font-black uppercase tracking-widest">Dashboard</span>
        </button>
        <button onclick="nav('update')" class="nav-btn flex flex-col items-center gap-1.5 text-slate-300 transition-all duration-300" id="nav-update">
            <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
            <span class="text-[9px] font-black uppercase tracking-widest">Input</span>
        </button>
        <button onclick="nav('settings')" class="nav-btn flex flex-col items-center gap-1.5 text-slate-300 transition-all duration-300" id="nav-settings">
            <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
            <span class="text-[9px] font-black uppercase tracking-widest">Tetapan</span>
        </button>
    </div>

    <script>

       

        // Versi 1.4 State
        let GAS_URL = localStorage.getItem('MECC_CLOUD_URL_V14') || '';
        let IS_LOCKED = localStorage.getItem('MECC_CLOUD_LOCKED_V14') === 'true';
        let ACTIVE_PROG = JSON.parse(localStorage.getItem('MECC_ACTIVE_PROG_V14')) || null;
        let RESPONDER = localStorage.getItem('MECC_RES_NAME_V14') || '';
        let localKesCount = parseInt(localStorage.getItem('MECC_KES_COUNT_V14')) || 0;
        const input = document.getElementById('backendUrlInput');
        
        function init() {
            document.getElementById('backendUrlInput').value = GAS_URL;
           // document.getElementById('resNameInput').value = RESPONDER;
            const el = document.getElementById('resNameInput');
                if(el) el.value = RESPONDER;
            document.getElementById('countKes').innerText = localKesCount;
            updateLockUI();
            if (ACTIVE_PROG) updateActiveProgDisplay();
            if (IS_LOCKED) {
                fetchPrograms();
                fetchAttendance();
            }
            nav('dashboard');
        }

        function nav(id) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('nav-active'));
            document.getElementById(id).classList.add('active');
            document.getElementById('nav-' + id).classList.add('nav-active');
        }

        // Popup Notification Engine
        function showPopup(type, title, msg) {
            const popup = document.getElementById('popupNotif');
            const icon = document.getElementById('popupIcon');
            const t = document.getElementById('popupTitle');
            const m = document.getElementById('popupMsg');

            const configs = {
                login: { icon: "üíé", color: "#0369a1" },
                logout: { icon: "üåô", color: "#64748b" },
                case: { icon: "‚úÖ", color: "#0891b2" },
                error: { icon: "‚ö†Ô∏è", color: "#e11d48" }
            };

            const config = configs[type] || configs.case;
            icon.innerText = config.icon;
            t.innerText = title;
            t.style.color = config.color;
            m.innerText = msg;
            
            popup.classList.add('active');
            
            // Auto hide after 6s
            setTimeout(hidePopup, 6000);
        }

        function hidePopup() {
            document.getElementById('popupNotif').classList.remove('active');
        }

        // Attendance Logic
        async function fetchAttendance() {
            if (!GAS_URL) return;
            const list = document.getElementById('attendanceList');
            try {
                const res = await fetch(`${GAS_URL}?type=getAttendance`); // Menyesuaikan dengan parameter ?type= di backend
                const data = await res.json();
                list.innerHTML = '';
                
                if (!data || data.length === 0) {
                    list.innerHTML = '<p class="text-xs text-slate-400 text-center py-8 italic bg-white/50 rounded-[32px] border border-dashed border-sky-200">Tiada log bertugas hari ini.</p>';
                    return;
                }

                document.getElementById('countRes').innerText = data.filter(r => !r.tamat).length;

                data.reverse().forEach(row => {
                    const isEnd = !!row.tamat;
                    const card = document.createElement('div');
                    card.className = `bg-white p-5 rounded-[28px] shadow-sm border ${isEnd ? 'border-slate-50 opacity-60' : 'border-sky-100 shadow-md pulse-sky'}`;
                    
                    const tMula = row.mula ? new Date(row.mula).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : "-";
                    const tTamat = isEnd ? new Date(row.tamat).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : "Sekarang";

                    card.innerHTML = `
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-[13px] font-black text-slate-800">${row.nama}</p>
                                <p class="text-[9px] text-slate-400 font-bold uppercase mt-0.5 tracking-tighter">üïí ${tMula} - ${tTamat}</p>
                            </div>
                            <div class="text-right">
                                <span class="text-[10px] font-black text-sky-700 bg-sky-50 px-2.5 py-1 rounded-full border border-sky-100">${row.kes} KES</span>
                                <p class="text-[8px] mt-1.5 font-black uppercase tracking-widest ${isEnd ? 'text-slate-300' : 'text-sky-500'}">${isEnd ? 'Tamat' : '‚óè Aktif'}</p>
                            </div>
                        </div>
                    `;
                    list.appendChild(card);
                });
            } catch (e) {
             list.innerHTML = `<p class="text-xs text-slate-400 text-center py-8 italic bg-white/50 rounded-[32px] border border-dashed border-sky-200">
                                      Tiada data petugas ditemui.
                                    </p>`;
            }
        }

        // Action Handlers
        async function handleDuty(action) {
            if (!IS_LOCKED) return showPopup('error', 'Konfigurasi!', 'Sila sahkan URL Cloud di menu Tetapan.');
            if (!RESPONDER) return showPopup('error', 'Identiti!', 'Sila masukkan nama anda sebelum mula.');

            const now = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            try {
                const payload = { name: RESPONDER, caseCount: localKesCount };
                await fetch(GAS_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action, payload }) });
                
                if (action === 'startDuty') {
                    showPopup('login', 'Selamat Bertugas!', `${RESPONDER}, log masuk anda direkodkan pada jam ${now}. Fokus & selamat!`);
                } else {
                    showPopup('logout', 'Selesai Tugas', `Terima kasih ${RESPONDER}. Log tamat tugas pada jam ${now} berjaya disimpan.`);
                }
                
                setTimeout(() => { fetchAttendance(); if(action==='endDuty') nav('dashboard'); }, 1500);
            } catch (e) { showPopup('error', 'cloud disconnected', 'Sambungan terputus. Sila cuba sebentar lagi.'); }
        }

        async function verifyCloud() {
            const url = document.getElementById('backendUrlInput').value.trim();
           // const input = document.getElementById('backendUrlInput');

            if (!url.startsWith('https://')) return showPopup('error', 'URL Tidak Sah', 'URL mestilah bermula dengan https://script.google.com');
            try {
                await fetch(url, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'ping' }) });
                GAS_URL = url; IS_LOCKED = true;
                localStorage.setItem('MECC_CLOUD_URL_V14', url);
                localStorage.setItem('MECC_CLOUD_LOCKED_V14', 'true');
                updateLockUI(); fetchPrograms(); fetchAttendance();
                showPopup('login', 'Cloud Aktif!', 'Sistem v1.4 berjaya disambungkan ke pangkalan data Cloud anda.');
            } catch (e) { showPopup('error', 'Gagal', 'Sila pastikan Web App di-deploy sebagai "Anyone".'); }
        }

        function resetCloud() {
            if (confirm("Reset sambungan? Semua data lokal akan dikekalkan.")) {
                IS_LOCKED = false;
                localStorage.setItem('MECC_CLOUD_LOCKED_V14', 'false');
                updateLockUI();
            }
        }

        function updateLockUI() {
            const input = document.getElementById('backendUrlInput');
            const stat = document.getElementById('statusDot');
            const txt = document.getElementById('statusText');
            if (IS_LOCKED) {
                input.readOnly = true;
                document.getElementById('btnVerify').classList.add('hidden');
                document.getElementById('btnReset').classList.remove('hidden');
                stat.classList.replace('bg-red-500', 'bg-sky-500');
                txt.innerText = "DALAM TALIAN";
            } else {
                input.readOnly = false;
                document.getElementById('btnVerify').classList.remove('hidden');
                document.getElementById('btnReset').classList.add('hidden');
                stat.classList.replace('bg-sky-500', 'bg-red-500');
                txt.innerText = "LUAR TALIAN";
            }
        }

        async function fetchPrograms() {
            const select = document.getElementById('progSelect');
            if(!GAS_URL){
            select.innerHTML = '<option value="">-- Cloud belum disambung --</option>';
            return;
              }
            
            
            try {
                const res = await fetch(`${GAS_URL}?type=getPrograms`);
                const data = await res.json();
                // JIKA TIADA DATA
                    if(!Array.isArray(data) || data.length === 0){
                      select.innerHTML = '<option value="">-- Tiada program disimpan --</option>';
                      return;
                    }
                    data.forEach(p => {
                    const opt = document.createElement('option');
                    opt.value = p.id || p.idprogram;
                    opt.innerText = p.namaprogram;
                    if (ACTIVE_PROG && opt.value === ACTIVE_PROG.id) opt.selected = true;
                    select.appendChild(opt);
                });
            } catch (e) {
                // ‚ùå JANGAN papar ralat
                select.innerHTML = '<option value="">-- Tidak dapat muat senarai program --</option>';
            }
        }

        function selectProgram(id) {
            
                         if(!select || !id) return;
            const select = document.getElementById('progSelect');
            const name = select.options[select.selectedIndex].text;
            ACTIVE_PROG = { id, namaprogram: name };
            localStorage.setItem('MECC_ACTIVE_PROG_V14', JSON.stringify(ACTIVE_PROG));
            updateActiveProgDisplay();
        }

        function updateActiveProgDisplay() {
            document.getElementById('dispProgName').innerText = ACTIVE_PROG.namaprogram;
            document.getElementById('dispProgId').innerText = "ID: " + ACTIVE_PROG.id;
        }

        function saveResponder(val) {
            localStorage.setItem('MECC_RES_NAME_V14', val);
            RESPONDER = val;
        }

        async function sendCaseToCloud() {
            if (!IS_LOCKED || !ACTIVE_PROG) return showPopup('error', 'Persediaan!', 'Sila aktifkan Cloud & pilih Program dahulu.');
            const pat = document.getElementById('casePatient').value.trim();
            const sym = document.getElementById('caseSymptom').value.trim();
            if (!pat || !sym) return showPopup('error', 'Data Kosong', 'Sila isi nama pesakit & aduan.');

            const payload = {
                id: "K-" + Date.now(),
                timestamp: new Date().toLocaleString(),
                responder: RESPONDER || "Admin",
                patient: { name: pat },
                medical: { symptoms: sym },
                finalStatus: document.getElementById('caseStatus').value,
                program: ACTIVE_PROG.namaprogram
            };

            try {
                await fetch(GAS_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'saveCase', payload }) });
                showPopup('case', 'Berjaya!', `Rekod kes bagi ${pat} telah selamat dihantar ke Cloud.`);
                localKesCount++;
                localStorage.setItem('MECC_KES_COUNT_V14', localKesCount);
                document.getElementById('countKes').innerText = localKesCount;
                document.getElementById('casePatient').value = "";
                document.getElementById('caseSymptom').value = "";
                setTimeout(() => { nav('dashboard'); fetchAttendance(); }, 2000);
            } catch (e) { showPopup('error', 'Ralat Penghantaran', 'Data gagal dihantar. Semak talian internet anda.'); }
        }
async function updateProgram() {
    if (!IS_LOCKED) {
        return showPopup('error', 'Cloud Tidak Aktif', 'Sila sahkan sambungan Cloud dahulu.');
    }

    const name = document.getElementById('progName').value.trim();
    const date = document.getElementById('progDate').value;
    const time = document.getElementById('progTime').value;
    const location = document.getElementById('progLocation').value.trim();

    if (!name || !date || !time || !location) {
        return showPopup('error', 'Maklumat Tidak Lengkap', 'Sila lengkapkan semua butiran program.');
    }

    const payload = {
        id: ACTIVE_PROG ? ACTIVE_PROG.id : "P-" + Date.now(),
        name,
        date,
        time,
        location
    };

    try {
        await fetch(GAS_URL, {
            method: 'POST',
            mode: 'no-cors',
            body: JSON.stringify({
                action: 'updateProgram',
                payload
            })
        });

        ACTIVE_PROG = { id: payload.id, namaprogram: name };
        localStorage.setItem('MECC_ACTIVE_PROG_V14', JSON.stringify(ACTIVE_PROG));
        updateActiveProgDisplay();

        showPopup(
            'case',
            'Program Dikemaskini',
            'Maklumat program berjaya disimpan ke Cloud.'
        );

    } catch (e) {
        showPopup('error', 'Ralat', 'Gagal menyimpan data program.');
    }
}
        // Toggle backend setup form
function toggleBackendSetup(){
  const form=document.getElementById('backendSetupForm');
  form.classList.toggle('hidden');
}

// Update URL script backend
function updateBackendUrl(){
  const url=document.getElementById('backendUrlInput').value.trim();
  if(!url){ showPopup('error','Ralat','Masukkan URL Cloud'); return; }
  GAS_URL=url;
  if(!GAS_URL.endsWith('/')) GAS_URL+='/';
  localStorage.setItem('MECC_CLOUD_URL_V14',GAS_URL);
  IS_LOCKED=true;
  localStorage.setItem('MECC_CLOUD_LOCKED_V14','true');
  checkBackendStatus();
  showPopup('login','Cloud Disambung',GAS_URL);
}

// Toggle program form
function toggleProgramForm(){
  const form=document.getElementById('programForm');
  form.classList.toggle('hidden');
  generateProgramId(); // automatik generate ID semasa buka form
}
         function getSaveMode(){
        const selected = document.querySelector('input[name="saveMode"]:checked');
          return selected ? selected.value : 'local';
            }

// Generate Program ID format DDMMYY+NoProgram
function generateProgramId(){
  const date=new Date();
  const dd=("0"+date.getDate()).slice(-2);
  const mm=("0"+(date.getMonth()+1)).slice(-2);
  const yy=date.getFullYear().toString().slice(-2);
 // const progCount=(JSON.parse(localStorage.getItem('MECC_PROGRAMS'))||[]).length+1;
    const progCount = Date.now().toString().slice(-3);
  const id=dd+mm+yy+'+'+("00"+progCount).slice(-3);
  document.getElementById('progIdDisplay').innerText="ID: "+id;
}

// Save program old code ; local only 
     //function saveProgram(){
      //const name=document.getElementById('progName').value.trim();
      //const date=document.getElementById('progDate').value;
      //const location=document.getElementById('progLocation').value;
      //const id=document.getElementById('progIdDisplay').innerText.replace("ID: ","");
    //  if(!name||!date||!location){ showPopup('error','Ralat','Sila lengkapkan semua medan'); return; }
    //  const programs=JSON.parse(localStorage.getItem('MECC_PROGRAMS'))||[];
      //programs.push({id,name,date,location});
  //localStorage.setItem('MECC_PROGRAMS',JSON.stringify(programs));
 // showPopup('case','Program Disimpan lokal ',name);
//  document.getElementById('programForm').classList.add('hidden');
//  updateProgramDots();
//}
        async function saveProgram(){
  const name = document.getElementById('progName').value.trim();
  const date = document.getElementById('progDate').value;
  const location = document.getElementById('progLocation').value;
  const id = document.getElementById('progIdDisplay').innerText.replace("ID: ","");

  if(!name || !date || !location){
    return showPopup('error','Ralat','Sila lengkapkan semua medan');
  }

  const payload = { id, name, date, location };
  const mode = getSaveMode();

  /* =====================
     SIMPAN LOKAL
  ====================== */
  if(mode === 'local'){
    const programs = JSON.parse(localStorage.getItem('MECC_PROGRAMS')) || [];
    programs.push(payload);
    localStorage.setItem('MECC_PROGRAMS', JSON.stringify(programs));

    showPopup('case','Program Disimpan (Lokal)', name);
    updateProgramDots();
    document.getElementById('programForm').classList.add('hidden');
    return;
  }

  /* =====================
     SIMPAN CLOUD
  ====================== */
  if(mode === 'cloud'){
    if(!IS_LOCKED || !GAS_URL){
      return showPopup(
        'error',
        'Cloud Tidak Aktif',
        'Sila sambungkan Cloud di Tetapan dahulu.'
      );
    }

    try{
      await fetch(GAS_URL,{
        method:'POST',
        mode:'no-cors',
        body:JSON.stringify({
          action:'saveProgram',
          payload
        })
      });

      // set active program
      ACTIVE_PROG = { id, namaprogram: name };
      localStorage.setItem('MECC_ACTIVE_PROG_V14', JSON.stringify(ACTIVE_PROG));
      updateActiveProgDisplay();

      showPopup('case','Program Disimpan (Cloud)', name);
      document.getElementById('programForm').classList.add('hidden');

    }catch(e){
      showPopup('error','Ralat Cloud','Gagal simpan ke Cloud.');
    }
  }
}


// Update dots bilangan program
function updateProgramDots(){
  const programs=JSON.parse(localStorage.getItem('MECC_PROGRAMS'))||[];
  const dots='‚óè'.repeat(programs.length);
  document.getElementById('programDots').innerText=dots||'1‚óè';
}

// Update backend status realtime
//async function updateBackendStatus(){
//  if(!IS_LOCKED || !GAS_URL) return;
//  const statusEl=document.getElementById('backendStatus');
//  try{
//    const res=await fetch(GAS_URL+"?type=ping");
 //   if(res.ok) statusEl.innerText="ONLINE";
 //   else statusEl.innerText="MASALAH BACKEND";
//  }catch(e){
 //   statusEl.innerText="LUAR TALIAN";
//  }
//}
        // Update backend status realtime code baru 
        async function checkBackendStatus(){
  const status = document.getElementById('backendStatus');
  if(!status) return;

  try{
    const res = await fetch(GAS_URL + "?type=ping");
    IS_LOCKED = res.ok;
  }catch(e){
    IS_LOCKED = false;
  }

  if(IS_LOCKED){
    status.innerText = "ONLINE";
    status.className = "text-xs font-black px-2 py-1 rounded-full border text-green-600 border-green-200";
  }else{
    status.innerText = "LUAR TALIAN";
    status.className = "text-xs font-black px-2 py-1 rounded-full border text-red-600 border-red-200";
  }
}

        function emptyMessage(text){
  return `
  <p class="text-xs text-slate-400 text-center py-8 italic 
  bg-white/50 rounded-[32px] border border-dashed border-sky-200">
    ${text}
  </p>`;
}
list.innerHTML = emptyMessage("Tiada data program disimpan.");
select.innerHTML = '<option value="">-- Tiada program ditemui --</option>';


// Panggil semasa init
updateProgramDots();
setInterval(checkBackendStatus,15000);

        window.onload = init;
    </script>
</body>
</html>
